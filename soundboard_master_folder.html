<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Offline Soundboard</title>
<style>
  body{
    margin:0;
    background:#0b0b0b;
    color:white;
    font-family:sans-serif;
    display:flex;
    flex-direction:column;
    height:100vh;
  }
  header{
    background:#161616;
    padding:10px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
    box-shadow:0 2px 5px rgba(0,0,0,0.5);
  }
  button{
    background:#222;
    color:white;
    border:none;
    padding:10px 20px;
    border-radius:6px;
    cursor:pointer;
    font-size:16px;
    transition:background 0.2s;
  }
  button:hover{
    background:#333;
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:20px;
    padding:20px;
    flex:1;
    overflow:auto;
    justify-items:center;
  }
  .sound-btn{
    border-radius:50%;
    width:100px;
    height:100px;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    font-size:14px;
    text-align:center;
    transition:transform 0.2s;
    color:#fff;
  }
  .sound-btn:hover{
    transform:scale(1.05);
  }
  .label{
    margin-top:8px;
    font-size:12px;
    color:#ccc;
    text-align:center;
    max-width:100px;
    word-wrap:break-word;
  }
</style>
</head>
<body>
<header>
  <h1>Offline Soundboard</h1>
  <div>
    <button id="pick-master">Pick Master Folder</button>
    <button id="stop-all">Stop All</button>
  </div>
</header>
<div class="grid" id="grid"></div>
<script>
let currentAudio = null;
let masterHandle = null;
let logFileHandle = null;

function isAudioFile(name){
  return /\.(mp3|wav|ogg|m4a)$/i.test(name);
}

function randomColor(){
  const colors=["#e74c3c","#8e44ad","#3498db","#16a085","#f39c12","#d35400","#2ecc71","#1abc9c","#9b59b6","#c0392b"];
  return colors[Math.floor(Math.random()*colors.length)];
}

async function readLog(){
  try{
    const file = await logFileHandle.getFile();
    const text = await file.text();
    return JSON.parse(text || '{}');
  }catch(e){
    return {};
  }
}

async function writeLog(data){
  const writable = await logFileHandle.createWritable();
  await writable.write(JSON.stringify(data));
  await writable.close();
}

async function loadSoundPack(folderHandle){
  const grid=document.getElementById('grid');
  grid.innerHTML='';
  for await (const [name, handle] of folderHandle.entries()){
    if(handle.kind==='file' && isAudioFile(name)){
      const container=document.createElement('div');
      container.style.display='flex';
      container.style.flexDirection='column';
      container.style.alignItems='center';

      const btn=document.createElement('div');
      btn.className='sound-btn';
      btn.style.background=randomColor();
      btn.onclick=async()=>{
        if(currentAudio){currentAudio.pause();currentAudio=null;}
        const file=await handle.getFile();
        const url=URL.createObjectURL(file);
        const audio=new Audio(url);
        audio.volume=0.4;
        currentAudio=audio;
        audio.play();
      };

      const label=document.createElement('div');
      label.className='label';
      label.textContent=name.replace(/\.[^/.]+$/,"");

      container.appendChild(btn);
      container.appendChild(label);
      grid.appendChild(container);
    }
  }
}

async function listSoundPacks(){
  const foldersHandle = await masterHandle.getDirectoryHandle('folders');
  const packs = [];
  for await (const [name, handle] of foldersHandle.entries()){
    if(handle.kind==='directory'){
      packs.push({name, handle});
    }
  }
  return packs;
}

document.getElementById('pick-master').onclick=async()=>{
  masterHandle = await window.showDirectoryPicker();
  logFileHandle = await masterHandle.getFileHandle('log.json', {create:true});
  const logData = await readLog();

  if(logData.lastOpened){
    if(confirm(`Previously opened sound pack: "${logData.lastOpened}". Open it again?`)){
      const foldersHandle = await masterHandle.getDirectoryHandle('folders');
      const packHandle = await foldersHandle.getDirectoryHandle(logData.lastOpened);
      loadSoundPack(packHandle);
      return;
    }
  }

  const packs = await listSoundPacks();
  const choice = prompt(`Available sound packs:\n${packs.map(p=>p.name).join('\n')}\n\nEnter the name of the pack to open:`);
  if(choice){
    const pack = packs.find(p=>p.name === choice);
    if(pack){
      await writeLog({lastOpened: choice});
      loadSoundPack(pack.handle);
    }
  }
};

document.getElementById('refresh').onclick=async()=>{
  if(masterHandle){
    if(confirm('Re-authorize access to the master folder?')){
      masterHandle = await window.showDirectoryPicker();
      logFileHandle = await masterHandle.getFileHandle('log.json', {create:true});
    }
  }
};

document.getElementById('stop-all').onclick=()=>{
  if(currentAudio){currentAudio.pause();currentAudio=null;}
};
</script>
</body>
</html>
